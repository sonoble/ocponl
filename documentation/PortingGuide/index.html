<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <title>Open Network Linux - Documentation - Porting Guide - Open Network Linux</title>
    <meta name="generator" content="Hugo 0.16" />

    
    <meta name="description" content="A material design theme for documentations.">
    
    <link rel="canonical" href="http://ocp.opennetlinux.org/documentation/PortingGuide/">
    
    <meta name="author" content="Digitalcraftsman">
    

    <meta property="og:url" content="http://ocp.opennetlinux.org/documentation/PortingGuide/">
    <meta property="og:title" content="Open Network Linux">
    <meta property="og:image" content="http://ocp.opennetlinux.org/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Open Network Linux">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="http://ocp.opennetlinux.org/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="http://ocp.opennetlinux.org/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('http://ocp.opennetlinux.org/fonts/icon.eot?52m981');
        src: url('http://ocp.opennetlinux.org/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
             url('http://ocp.opennetlinux.org/fonts/icon.woff?52m981')
               format('woff'),
             url('http://ocp.opennetlinux.org/fonts/icon.ttf?52m981')
               format('truetype'),
             url('http://ocp.opennetlinux.org/fonts/icon.svg?52m981#icon')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="http://ocp.opennetlinux.org/stylesheets/application.css">
    <link rel="stylesheet" href="http://ocp.opennetlinux.org/stylesheets/temporary.css">
    <link rel="stylesheet" href="http://ocp.opennetlinux.org/stylesheets/palettes.css">
    <link rel="stylesheet" href="http://ocp.opennetlinux.org/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu%2bMono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="http://ocp.opennetlinux.org/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-red palette-accent-light green">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Open Network Linux - Documentation - Porting Guide
      </div>
    </div>

    
    <div class="button button-twitter" role="button" aria-label="Twitter">
       <a href="https://twitter.com/opennetlinux" title="@opennetlinux on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
    </div>
    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/opennetworklinux" title="@opennetworklinux on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/opencomputeproject/OpenNetworkLinux" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="http://ocp.opennetlinux.org/images/logo.png">
        </div>
      
      <div class="name">
        <strong>Open Network Linux <span class="version">2.0.0</span></strong>
        
          <br>
          OpenNetworkLinux
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="http://opennetlinux.org/binaries" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/opencomputeproject/OpenNetworkLinux/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Home" href="http://ocp.opennetlinux.org/">
	
	Home
</a>


  
</li>



<li>
  
    



<a  title="Documentation" href="http://ocp.opennetlinux.org/documentation/">
	
	Documentation
</a>


  
</li>



<li>
  
    



<a  title="Download Binaries" href="http://ocp.opennetlinux.org/binaries/">
	
	Download Binaries
</a>


  
</li>



<li>
  
    



<a  title="Getting started" href="http://ocp.opennetlinux.org/getting-started/">
	
	Getting started
</a>


  
</li>



<li>
  
    



<a  title="FAQ" href="http://ocp.opennetlinux.org/faq/">
	
	FAQ
</a>


  
</li>



<li>
  
    



<a  title="Community" href="http://ocp.opennetlinux.org/community/">
	
	Community
</a>


  
</li>



<li>
  
    



<a  title="Blog" href="http://ocp.opennetlinux.org/blog/">
	
	Blog
</a>


  
</li>



<li>
  
    



<a  title="Wedge" href="http://ocp.opennetlinux.org/wedge/">
	
	Wedge
</a>


  
</li>



<li>
  
    



<a  title="License" href="http://ocp.opennetlinux.org/license/">
	
	License
</a>


  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          
          <li>
            <a href="https://twitter.com/opennetlinux" target="_blank" title="@opennetlinux on Twitter">
              @opennetlinux on Twitter
            </a>
          </li>
          

          
          <li>
            <a href="https://github.com/opennetworklinux" target="_blank" title="@opennetworklinux on GitHub">
              @opennetworklinux on GitHub
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Open Network Linux - Documentation - Porting Guide </h1>

			

<h1 id="overview">Overview</h1>

<p>Open Network Linux has a number of internal APIs to simplify porting to
new hardware.</p>

<p>To support a new switch/device, there are three large software components
that need device-specific drivers (information only known by the manufacturer
of the switch/device):</p>

<ol>
<li>The ONL/ONIE installer &ndash; how to install and boot ONL using ONIE</li>
<li>The ONLP platform drivers &ndash; how to manage hardware once ONL is running</li>
<li>Any packet forwarding device specific settings
(e.g., front panel port mappings, pre-emphesis settings)</li>
</ol>

<p>ONL provides plugable driver modules for (1) and (2) but currently
provides no support for (3) &ndash; this is work in progress.</p>

<p>The rest this PortingGuide is divided into two parts: (1) creating
the ONIE installer driver and (2) creating the ONLP platform driver.</p>

<h1 id="onl-installer">ONL Installer</h1>

<h2 id="about-onie">About ONIE</h2>

<p>ONIE (the Open Network Installation Environment - <a href="http://onie.org">http://onie.org</a>)
is a small piece of software that ONL expects to exist on every
switch, pre-installed by the switch vendor.  ONIE provides the
installation and management utilities to install/uninstall/rescue
a Network Operating System (a &ldquo;NOS&rdquo;) like ONL.  While ONIE is a
stand alone operating system in its own right, it is intentionally
stripped down and has few features outside of the bare minimum
needed to bootstrap a system and invoke an NOS installer program.</p>

<h2 id="onl-installer-operation">ONL Installer Operation</h2>

<p>ONL has an ONIE-compatible installation script called the &lsquo;ONL
Installer&rsquo;.  That is, the ONL installer is a device-specific
self-extracting shell script that, when run from ONIE, partitions
available storage, installs the ONL switch image file (SWI) on to
disk, and sets up the underlying boot loader (e.g., uboot or grub)
with the appropriate settings so that on boot, by default, ONL loads
correctly on the device.  So, to port ONL to a new switch, a number
of installer drivers, including for disk partitioning, installation,
booting, and python integration need to be written.</p>

<h2 id="onl-installer-example-code">ONL Installer Example Code</h2>

<p>TL; DR :: If you want to just jump to the code, look at the drivers
in $ONL/packages/platforms/$vendor/$platform/platform-config/r(0|1)/* &ndash; in particular, the
powerpc-as5710-54x-r0b driver is a good example.  Copy the directory/file layout and naming conventions and
see how the driver code is called from $ONL/builds/powerpc/installer/legacy/builds/ppc-installer.sh</p>

<h2 id="onl-installer-file-layout">ONL Installer file layout</h2>

<p>All the installer drivers are stored in $ONL/packages/platforms/$vendor/$platform/platform-config,
where $platform corresponds to the ONIE platform identifier string and $vendor is the name of the platform
vendor e.g. accton, quanta, wnc.  This string is used to identify which set of drivers to load (ONL supports
many systems) at boot time and is critical that it matches the ONIE identifier exactly.  The rest of the
directory structure for the installer driver is as follows:</p>

<pre><code>./$platform/$release/
./$platform/$release/Makefile                    # copy from existing driver
./$platform/$release/src/lib/boot/detect.sh          # Script that returns 0 if run on $platform, 1 otherwise
./$platform/$release/src/lib/boot/$platform          # Script run on boot that populates device/hardware
                                        #       specific ONL OS abstractions (see below)
./$platform/$release/src/lib/install/$platform.sh    # Script called from installer.sh to partition
                                        # and install ONL and setup boot params (see below)
./$platform/src/python/$platform/__init__.py         # Platform specific python library (see below)
</code></pre>

<h2 id="onl-installer-src-boot-drivers">ONL Installer src/boot drivers</h2>

<p>The $platform/src/lib/boot/$platform script is in charge of writing
the ONL boottime hardware abstraction configuration.  Because each
device has a different storage driver, storage device, management
network device, etc., ONL uses a series of config files to map the
specific hardware (an ethernet driver) to a device-agnostic form
(e.g., primary management interface).</p>

<p>The following files need to be populated by the $platform boot script:
* /etc/onl/net : The PCI device name and interface name of the management ethernet
* /etc/onl/mounts : The devices that correspond to /mnt/flash and /mnt/flash2 at boot
* /etc/fw_env.config : The device and configuration of the firmware device, for fw_printenv, fw_setenv</p>

<h2 id="onl-installer-src-install-drivers">ONL Installer src/install drivers</h2>

<p>The $platform/src/lib/install/$platform.sh driver is called from the main installer script and has the job
of:
1) Identifying and partitioning the device specific storage
2) Deciding the file format of the target boot partition to install the ONL loader image
3) Deciding how to update the bootloader, e.g., in the case of uboot, what the $nos_bootcmd variables
    should be.</p>

<p>The contents of this driver are sourced into the installer.sh and
so the variables and functions are called in various places.  There
are an excess of ways that switches can be built (what storage
types, etc.) and how they boot, so seading the installer.sh code
along with the example platform driver code seems to be the best
bet here &ndash; FIXME!</p>

<p>For example, looking at the driver
<code>$ONL/packages/platforms/accton/powerpc-accton-as5710-54x/platform-config/r0b/src/lib/install/powerpc-as5710-54x-r0b.sh</code>
the driver first sets &ldquo;platform_loader_raw=1&rdquo; which tells the
installer that the boot partition has no file format (as opposed
to ext2fs or fat - it is type &lsquo;raw&rsquo;).  Then it has the platform_bootcmd as:</p>

<p><code>platform_bootcmd='usb start; usbboot 0x10000000 0:1; setenv bootargs console=$consoledev,$baudrate onl_platform=powerpc-as5710-54x-r0b; bootm 0x10000000'</code></p>

<p>Which is a string of uboot commands, that:</p>

<ol>
<li>usb start &ndash; initialize the usb subsystems</li>
<li>Using the usb boot loader, load the contents of device 0, partition 1 (0:1) into memory range 0x10000000</li>
<li>Pass a number of env variables to the kernel at boot via $bootargs</li>
<li>Actually just jump to memory 0x10000000 and start running (bootm 0x100000000)</li>
</ol>

<p>The sequence of exact boot commands will vary with version of uboot
(or other boot loader), available storage, and other device specific
properties.</p>

<h2 id="onl-installer-src-python-drivers">ONL Installer src/python drivers</h2>

<h1 id="open-network-linux-platform-onlp-apis">Open Network Linux Platform (&ldquo;ONLP&rdquo;) APIs</h1>

<p>Every new networking switch/router/box has a unique layout of which
devices (fans, power supplies, LEDs, SFP/SFP+/QSFP, temperature
sensors, etc.) connect to which I/O devices (I2C, GPIO, etc.) and
how they are managed (FPGA, CPLD).  Rather than mandate one hardware
approach or assume that there exists a BIOS to take care of this
work for us (some platforms have a BIOS, some do not; some drivers
are not supported by BIOS), ONL has created an abstraction layer
to inventory, manage, and monitor these devices.</p>

<h2 id="onlp-application-apis">ONLP Application APIs</h2>

<p>If you want to create an application in ONL that builds on top of the
platform, the &ldquo;application to platform&rdquo; APIs are found in:</p>

<pre><code>$ONL/packages/base/any/onlp/src/onlp/module/inc/onlp
</code></pre>

<p>This section will have to become better documented, but look at the example
code in the <code>onlpdump</code> driver for how to call the ONLP APIs as an application.</p>

<p>At a high-level, each hardware device is given a unique Object ID
(OID).  Each type of device has a number of different properties that
is querable/programmable (e.g., read/set fan speed, query an SFP+ port
status, etc.)  and a mechanism for negotiating hardware capabilities
(e.g., is the fan speed setable?  reversible? does this SFP have a
hardware interupt bit on link down?).</p>

<p>The ONLP API is has internal locking so it supports multiple concurrent
callers.  That said, there is no inter-application internal hardware
contention resolution, so, if for example one application wants the fans
at 25% and another wants them at 75%, the last caller wins.</p>

<p>Applications start by getting a tree of OIDs from the platform using the
 onlp_sys_init(void) and onlp_sys_info_get() calls.  There exist a number
of macros for interogating OID types in oid.h, ala ONLP_OID<em>IS</em>*().</p>

<h2 id="onlpi-driver-apis">ONLPI Driver APIs</h2>

<p>If you want to create a driver so that your new hardware can work with
ONL, the &ldquo;platform to hardware&rdquo; APIs are found in:</p>

<pre><code>$ONL/packages/base/any/onlp/src/onlp/module/inc/onlp/platformi
</code></pre>

<p>This section will have to become better documented,
but look at the example driver &lsquo;onlpie&rsquo; implementation at
$ONL/packages/base/any/onlp/src/onlpie/module/src/.  Many driver
implementations have been written and they will become available over
time.</p>

<p>At a high-level, the driver is responsible for providing implementations
of the various &lsquo;platformi&rsquo; APIs, e.g., sysi.h, fani.h, etc.  Whether
these implementations are provided via user-space or kernel space is an
implementation detail left to the driver maintainer.</p>

<p>In terms of programming paradigm, the application calls into the platform
code (see above) and then the platform code calls into the driver.  The main
platform code handles locking to ensure that the underlying driver code does
not need to be re-entrant or handle concurrent API calls.  This dramatically
simplifies the ONLPI driver code and we have found in most cases that code
from existing projects (e.g., from an ODM diagnostic utilities) can be readily
cut and pasted into place.</p>

<p>Feedback on these APIs are welcome.</p>


			<aside class="copyright" role="note">
				
				&copy; 2016 Released under the MIT license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="http://ocp.opennetlinux.org/documentation/SupportedHardware/" title="Open Network Linux - Documentation - HCL">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Open Network Linux - Documentation - HCL
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="http://ocp.opennetlinux.org/documentation/" title="Open Network Linux - Documentation">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Open Network Linux - Documentation
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'http:\/\/ocp.opennetlinux.org\/';
      var repo_id  = 'OpenNetworkLinux';
    
    </script>

    <script src="http://ocp.opennetlinux.org/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;
            
            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }
        

        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//gohugo.io/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
